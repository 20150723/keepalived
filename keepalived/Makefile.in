# Makefile
#
# Keepalived OpenSource project.
#
# Copyright (C) 2001, 2002, 2003 Alexandre Cassen, <acassen@linux-vs.org>

EXEC      = keepalived
BIN       = ../bin
KERNEL    = @KERN@
IPVS_FLAG = @IPVS_SUPPORT@
VRRP_FLAG = @VRRP_SUPPORT@

prefix      = @prefix@
exec_prefix = @exec_prefix@
sbindir     = @sbindir@
sysconfdir  = @sysconfdir@
init_script = etc/init.d/keepalived.init
conf_file   = etc/keepalived/keepalived.conf

CC = @CC@
LDFLAGS = @LIBS@ @LDFLAGS@ -ldl
SUBDIRS = core

ifeq ($(IPVS_FLAG),_WITH_LVS_)
  SUBDIRS += check
endif

ifeq ($(VRRP_FLAG),_WITH_VRRP_)
  SUBDIRS += vrrp
endif

ifeq ($(IPVS_FLAG),_WITH_LVS_)
  ifeq ($(KERNEL),_KRNL_2_2_)
    SUBDIRS += libipfwc
  else
    ifeq ($(KERNEL),_KRNL_2_4_)
      SUBDIRS += libipvs-2.4
    else
      SUBDIRS += libipvs-2.6
    endif
  endif
endif

all:
	@set -e; \
	for i in $(SUBDIRS); do \
	$(MAKE) -C $$i || exit 1; done && \
	echo "Building $(BIN)/$(EXEC)" && \
	$(CC) -o $(BIN)/$(EXEC) `find $(SUBDIRS) ../lib -name '*.[oa]'` $(LDFLAGS)
	strip $(BIN)/$(EXEC)
	@echo ""
	@echo "Make complete"

debug:
	@set -e; \
	for i in $(SUBDIRS); do \
	$(MAKE) -C $$i || exit 1; done && \
	echo "Building $(BIN)/$(EXEC)" && \
	$(CC) -o $(BIN)/$(EXEC) `find $(SUBDIRS) ../lib -name '*.[oa]'` $(LDFLAGS)
	@echo ""
	@echo "Make complete"

profile:
	@set -e; \
	for i in $(SUBDIRS); do \
	$(MAKE) -C $$i || exit 1; done && \
	echo "Building $(BIN)/$(EXEC)" && \
	$(CC) -o $(BIN)/$(EXEC) `find $(SUBDIRS) ../lib -name '*.[oa]'` $(LDFLAGS) -pg
	@echo ""
	@echo "Make complete"

clean:
	@set -e; \
	for i in $(SUBDIRS); do \
	$(MAKE) -C $$i clean; done
	@echo ""
	@echo "Make complete"

distclean:
	@set -e; \
	for i in $(SUBDIRS); do \
	$(MAKE) -C $$i distclean; done
	rm -f Makefile $(BIN)/$(EXEC)
	rm -f include/config.h

mrproper: distclean
	rm -f config.*

uninstall:
	rm -f $(DESTDIR)$(sbindir)/$(EXEC)
	rm -rf $(DESTDIR)$(sysconfdir)/keepalived
	rm -f $(DESTDIR)$(init_dir)/$(init_script)
	rm -f $(DESTDIR)$(prefix)@mandir@/man/man5/keepalived.conf.5
	rm -f $(DESTDIR)$(prefix)@mandir@/man/man8/keepalived.8

install:
	install -d $(DESTDIR)$(sbindir)
	install -m 700 $(BIN)/$(EXEC) $(DESTDIR)$(sbindir)/
	install -d $(DESTDIR)$(sysconfdir)/init.d
	install -m 755 $(init_script) $(DESTDIR)$(sysconfdir)/init.d/keepalived
	install -d $(DESTDIR)$(sysconfdir)/keepalived/samples
	install -m 644 $(conf_file) $(DESTDIR)$(sysconfdir)/keepalived/
	install -m 644 ../doc/samples/* $(DESTDIR)$(sysconfdir)/keepalived/samples/
	install -d $(DESTDIR)$(prefix)@mandir@/man/man5
	install -d $(DESTDIR)$(prefix)@mandir@/man/man8
	install -m 644 ../doc/man/man5/keepalived.conf.5 $(DESTDIR)$(prefix)@mandir@/man/man5
	install -m 644 ../doc/man/man8/keepalived.8 $(DESTDIR)$(prefix)@mandir@/man/man8
