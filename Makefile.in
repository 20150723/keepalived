# Makefile
#
# Keepalived OpenSource project.
#
# Copyright (C) 2001, 2002 Alexandre Cassen, <acassen@linux-vs.org>

EXEC = keepalived
KERNEL    := _KRNL_2_$(shell uname -r | cut -d'.' -f2)_
IPVS_FLAG := @IPVS_SUPPORT@
VRRP_FLAG := @VRRP_SUPPORT@
CI_LINUX  := @CI_LINUX@

prefix      = @prefix@
exec_prefix = @exec_prefix@
sbindir     = @sbindir@

init_dir            = @SYSTEM_SCRIPT_DIR@
init_script         = keepalived.init
src_init_script     = etc/rc.d/init.d/$(init_script)
src_conf_file       = etc/keepalived/keepalived.conf
keepalived_conf_dir = /etc/keepalived

CC = @CC@
CFLAGS = @CFLAGS@ \
	-Wall -Wunused -Wstrict-prototypes \
	-D$(KERNEL) -D$(VRRP_FLAG) @DFLAGS@
LDFLAGS = @LIBS@ @LDFLAGS@ @LIBFW@
IPVSFLAGS = -D$(IPVS_FLAG) -D@IPVS_SYNCD@

CORE_OBJS = @LIBOBJS@ \
	main.o \
	memory.o \
	daemon.o \
	pidfile.o \
	utils.o \
	timer.o \
	scheduler.o \
	vector.o \
	list.o \
	data.o \
	parser.o \
	layer4.o \
	smtp.o

ifeq ($(IPVS_FLAG),_WITH_LVS_)
IPVS_OBJS = \
	check_api.o \
	check_tcp.o \
	check_http.o \
	check_ssl.o \
	check_misc.o \
	ipwrapper.o \
	ipvswrapper.o
endif
        
ifeq ($(VRRP_FLAG),_WITH_VRRP_)
VRRP_OBJS = \
	vrrp.o \
	vrrp_scheduler.o \
	vrrp_sync.o \
	vrrp_netlink.o \
	vrrp_if.o \
	vrrp_ipaddress.o \
	vrrp_ipsecah.o
endif

ifeq ($(CI_LINUX),_WITH_CI_LINUX_)
CI_LINUX_OBJ = check_ci.o
CIFLAGS = -D$(CI_LINUX)
endif

INCLUDE = -I/usr/src/linux/include
OBJS    = $(CORE_OBJS) $(IPVS_OBJS) $(VRRP_OBJS) $(CI_LINUX_OBJ)

.c.o:
	$(CC) -o $@ $(CFLAGS) $(IPVSFLAGS) $(CIFLAGS) $(INCLUDE) -c $*.c

all:    $(EXEC)
	strip $(EXEC)
	@echo ""
	cd genhash && $(MAKE)
	@echo ""
	@echo "Make complete"

debug:  $(EXEC)
	@echo ""
	@echo "Make complete"

$(EXEC): $(OBJS) $(LDFLAGS)
	$(CC) -o $(EXEC) $(CFLAGS) $(OBJS) $(LDFLAGS)

libipfwc/libipfwc.a:
	cd libipfwc/ && $(MAKE) libipfwc.a

subclean:
ifeq ($(KERNEL),_KRNL_2_2_)
	cd libipfwc/ && $(MAKE) clean
endif
	cd genhash/ && $(MAKE) clean

clean: subclean
	rm -f core *.o $(EXEC)

subclean-dist:
	cd genhash/ && $(MAKE) clean-dist

clean-dist: subclean-dist
	rm -f $(sbindir)/$(EXEC)
	rm -rf $(keepalived_conf_dir)
	rm -f $(init_dir)/$(init_script)

mrproper: clean clean-dist
	rm -f config.*
	rm -f Makefile
	rm -f genhash/Makefile

subinstall:
	cd genhash/ && $(MAKE) install

install: subinstall
	install -m 700 $(EXEC) $(sbindir)/
	install -m 755 $(src_init_script) $(init_dir)/
	mkdir $(keepalived_conf_dir)
	install -m 644 $(src_conf_file) $(keepalived_conf_dir)
	mkdir $(keepalived_conf_dir)/samples
	install -m 644 samples/* $(keepalived_conf_dir)/samples/
