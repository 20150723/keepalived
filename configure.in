#
# Keepalived OpenSource project.
#
# Configuration template file for keepalived.
# autoconf will generate & check deps for proper compilation
#
# Copyright (C) 2001, 2002 Alexandre Cassen, <acassen@linux-vs.org>

dnl ----[ Process this file with autoconf to produce a configure script ]----
AC_INIT(scheduler.c)

dnl ----[ Checks for programs ]----
AC_PROG_CC
AC_PROG_INSTALL

dnl ----[ Checks for kernel support ]----
KERNEL_VERSION=`uname -r`

IPVS_MODULE="/lib/modules/`uname -r`/kernel/net/ipv4/ipvs/ip_vs.o"
if test -f $IPVS_MODULE; then
  modprobe ip_vs
fi

if test -f /proc/net/ip_vs; then
  IPVS_VERSION=`cat /proc/net/ip_vs | head -1 | awk '{ print $5}'`
elif test -f /proc/net/ip_masq/vs; then
  IPVS_VERSION=`cat /proc/net/ip_masq/vs | head -1 | awk '{ print $5}'`
else
  echo
  echo "!!!WARN!!! Your kernel need to be patched with LVS code !!!WARN!!!"
  echo
  exit 1
fi
VERSION=`cat VERSION`

dnl ----[ Checks for libraries ]----
AC_CHECK_LIB(crypto, MD5_Init,,AC_MSG_ERROR([OpenSSL libraries are required]))
AC_CHECK_LIB(ssl, SSL_CTX_new,,AC_MSG_ERROR([OpenSSL libraries are required]))
AC_CHECK_LIB(popt, poptGetContext,,AC_MSG_ERROR([Popt libraries is required]))

dnl ----[ Create object list ]----
KERNEL_CODE=`echo $KERNEL_VERSION | cut -d'.' -f2`
if test "${KERNEL_CODE}" = "2"; then
  LIBFW="libipfwc/libipfwc.a"
  LIBOBJS="$LIBOBJS ipfwwrapper.o"
  AC_SUBST(LIBFW)dnl
  AC_SUBST(LIBOBJS)dnl
fi

dnl ----[ Checks for header files ]----
AC_HEADER_STDC
AC_HEADER_SYS_WAIT
AC_CHECK_HEADERS(openssl/ssl.h openssl/md5.h openssl/err.h,,AC_MSG_ERROR([
  !!! OpenSSL is not properly installed on your system. !!!
  !!! Can not include OpenSSL headers files.            !!!]))
AC_CHECK_HEADERS(fcntl.h sys/ioctl.h sys/time.h syslog.h unistd.h)

dnl ----[ Checks for typedefs, structures, and compiler characteristics ]----
AC_C_CONST
AC_TYPE_PID_T
AC_HEADER_TIME

dnl ----[ Checks for library functions ]----
AC_PROG_GCC_TRADITIONAL
dnl AC_FUNC_MEMCMP
AC_TYPE_SIGNAL
AC_CHECK_FUNCS(gettimeofday select socket strerror strtol uname)

AC_OUTPUT(Makefile genhash/Makefile)

cat <<EOF;

Keepalived configuration
------------------------
Keepalived version   : ${VERSION}
Linux Kernel release : ${KERNEL_VERSION}
IPVS version code    : ${IPVS_VERSION}
Compiler             : ${CC}
Compiler flags       : ${CFLAGS}
Extra Lib            : $LIBS
Lib objects          : $LIBOBJS
Firewall Lib         : $LIBFW

EOF
